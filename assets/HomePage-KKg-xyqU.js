import{c as U,H as G,I as X,h as v,a as y,b as Y,J as ee,g as te,i as I,e as B,l as ae,f as ne,A as Z,t as x,o as ie,m as E,K as $,D as _,L as M,F as w,M as L,G as k,C as H,Q,N as O,O as D,E as C,P as q,R,S as se,T as oe,U as re,V,W as j}from"./index-BFxpJziR.js";import{Q as le,a as F,b as J}from"./QList-DJE-771J.js";import{u as T}from"./use-quasar-Z9-lQEjY.js";import{m as ce}from"./module-DaOc4yF3.js";import{i as z,b as ue,a as de}from"./common-CLxqkVLz.js";const ve='<g fill="none" fill-rule="evenodd" transform="translate(1 1)" stroke-width="2"><circle cx="22" cy="22" r="6"><animate attributeName="r" begin="1.5s" dur="3s" values="6;22" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="stroke-opacity" begin="1.5s" dur="3s" values="1;0" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="stroke-width" begin="1.5s" dur="3s" values="2;0" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="22" cy="22" r="6"><animate attributeName="r" begin="3s" dur="3s" values="6;22" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="stroke-opacity" begin="3s" dur="3s" values="1;0" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="stroke-width" begin="3s" dur="3s" values="2;0" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="22" cy="22" r="8"><animate attributeName="r" begin="0s" dur="1.5s" values="6;1;2;3;4;5;6" calcMode="linear" repeatCount="indefinite"></animate></circle></g>',me=U({name:"QSpinnerRings",props:G,setup(e){const{cSize:t,classes:n}=X(e);return()=>v("svg",{class:n.value,stroke:"currentColor",width:t.value,height:t.value,viewBox:"0 0 45 45",xmlns:"http://www.w3.org/2000/svg",innerHTML:ve})}}),K=U({name:"QItemLabel",props:{overline:Boolean,caption:Boolean,header:Boolean,lines:[Number,String]},setup(e,{slots:t}){const n=y(()=>parseInt(e.lines,10)),i=y(()=>"q-item__label"+(e.overline===!0?" q-item__label--overline text-overline":"")+(e.caption===!0?" q-item__label--caption text-caption":"")+(e.header===!0?" q-item__label--header":"")+(n.value===1?" ellipsis":"")),u=y(()=>e.lines!==void 0&&n.value>1?{overflow:"hidden",display:"-webkit-box","-webkit-box-orient":"vertical","-webkit-line-clamp":n.value}:null);return()=>v("div",{style:u.value,class:i.value},Y(t.default))}}),fe=U({name:"QChatMessage",props:{sent:Boolean,label:String,bgColor:String,textColor:String,name:String,avatar:String,text:Array,stamp:String,size:String,labelHtml:Boolean,nameHtml:Boolean,textHtml:Boolean,stampHtml:Boolean},setup(e,{slots:t}){const n=y(()=>e.sent===!0?"sent":"received"),i=y(()=>`q-message-text-content q-message-text-content--${n.value}`+(e.textColor!==void 0?` text-${e.textColor}`:"")),u=y(()=>`q-message-text q-message-text--${n.value}`+(e.bgColor!==void 0?` text-${e.bgColor}`:"")),h=y(()=>"q-message-container row items-end no-wrap"+(e.sent===!0?" reverse":"")),g=y(()=>e.size!==void 0?`col-${e.size}`:""),l=y(()=>({msg:e.textHtml===!0?"innerHTML":"textContent",stamp:e.stampHtml===!0?"innerHTML":"textContent",name:e.nameHtml===!0?"innerHTML":"textContent",label:e.labelHtml===!0?"innerHTML":"textContent"}));function r(d){return t.stamp!==void 0?[d,v("div",{class:"q-message-stamp"},t.stamp())]:e.stamp?[d,v("div",{class:"q-message-stamp",[l.value.stamp]:e.stamp})]:[d]}function c(d,s){const m=s===!0?d.length>1?f=>f:f=>v("div",[f]):f=>v("div",{[l.value.msg]:f});return d.map((f,S)=>v("div",{key:S,class:u.value},[v("div",{class:i.value},r(m(f)))]))}return()=>{const d=[];t.avatar!==void 0?d.push(t.avatar()):e.avatar!==void 0&&d.push(v("img",{class:`q-message-avatar q-message-avatar--${n.value}`,src:e.avatar,"aria-hidden":"true"}));const s=[];t.name!==void 0?s.push(v("div",{class:`q-message-name q-message-name--${n.value}`},t.name())):e.name!==void 0&&s.push(v("div",{class:`q-message-name q-message-name--${n.value}`,[l.value.name]:e.name})),t.default!==void 0?s.push(c(ee(t.default()),!0)):e.text!==void 0&&s.push(c(e.text)),d.push(v("div",{class:g.value},s));const m=[];return t.label!==void 0?m.push(v("div",{class:"q-message-label"},t.label())):e.label!==void 0&&m.push(v("div",{class:"q-message-label",[l.value.label]:e.label})),m.push(v("div",{class:h.value},d)),v("div",{class:`q-message q-message-${n.value}`},m)}}}),pe=U({name:"QPage",props:{padding:Boolean,styleFn:Function},setup(e,{slots:t}){const{proxy:{$q:n}}=te(),i=I(ae,B);if(i===B)return console.error("QPage needs to be a deep child of QLayout"),B;if(I(ne,B)===B)return console.error("QPage needs to be child of QPageContainer"),B;const h=y(()=>{const l=(i.header.space===!0?i.header.size:0)+(i.footer.space===!0?i.footer.size:0);if(typeof e.styleFn=="function"){const r=i.isContainer.value===!0?i.containerHeight.value:n.screen.height;return e.styleFn(l,r)}return{minHeight:i.isContainer.value===!0?i.containerHeight.value-l+"px":n.screen.height===0?l!==0?`calc(100vh - ${l}px)`:"100vh":n.screen.height-l+"px"}}),g=y(()=>`q-page${e.padding===!0?" q-layout-padding":""}`);return()=>v("main",{class:g.value,style:h.value},Y(t.default))}}),he='<rect y="10" width="15" height="120" rx="6"><animate attributeName="height" begin="0.5s" dur="1s" values="120;110;100;90;80;70;60;50;40;140;120" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="y" begin="0.5s" dur="1s" values="10;15;20;25;30;35;40;45;50;0;10" calcMode="linear" repeatCount="indefinite"></animate></rect><rect x="30" y="10" width="15" height="120" rx="6"><animate attributeName="height" begin="0.25s" dur="1s" values="120;110;100;90;80;70;60;50;40;140;120" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="y" begin="0.25s" dur="1s" values="10;15;20;25;30;35;40;45;50;0;10" calcMode="linear" repeatCount="indefinite"></animate></rect><rect x="60" width="15" height="140" rx="6"><animate attributeName="height" begin="0s" dur="1s" values="120;110;100;90;80;70;60;50;40;140;120" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="y" begin="0s" dur="1s" values="10;15;20;25;30;35;40;45;50;0;10" calcMode="linear" repeatCount="indefinite"></animate></rect><rect x="90" y="10" width="15" height="120" rx="6"><animate attributeName="height" begin="0.25s" dur="1s" values="120;110;100;90;80;70;60;50;40;140;120" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="y" begin="0.25s" dur="1s" values="10;15;20;25;30;35;40;45;50;0;10" calcMode="linear" repeatCount="indefinite"></animate></rect><rect x="120" y="10" width="15" height="120" rx="6"><animate attributeName="height" begin="0.5s" dur="1s" values="120;110;100;90;80;70;60;50;40;140;120" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="y" begin="0.5s" dur="1s" values="10;15;20;25;30;35;40;45;50;0;10" calcMode="linear" repeatCount="indefinite"></animate></rect>',ge=U({name:"QSpinnerBars",props:G,setup(e){const{cSize:t,classes:n}=X(e);return()=>v("svg",{class:n.value,fill:"currentColor",width:t.value,height:t.value,viewBox:"0 0 135 140",xmlns:"http://www.w3.org/2000/svg",innerHTML:he})}}),_e={class:"column items-center q-gutter-y-sm"},be={key:0,class:"row"},we={class:"text-red"},ye={key:1,class:"text-italic"},Ce=Z({__name:"AudioRecorder",props:{disable:{type:Boolean,default:!1}},emits:["stop"],setup(e,{emit:t}){const n=t,{notify:i,platform:u}=T(),h=z("components.AudioRecorder"),g=x([]),l=x(!1),r=x(),c=x(),d=()=>{if(!(l.value||!c.value))try{r.value=new ce(c.value,{mimeType:"audio/wav"}),r.value.ondataavailable=m=>{g.value.push(m.data)},r.value.onstop=()=>{c.value&&(n("stop",new Blob(g.value,{type:"audio/wav"})),g.value=[])},r.value.start(),l.value=!0}catch(m){i({type:"negative",message:h("labels.error"),caption:m.message})}},s=()=>{r.value?.state==="recording"&&(r.value.stop(),l.value=!1)};return ie(async()=>{c.value=await navigator.mediaDevices.getUserMedia({audio:!0})}),E(()=>{c.value&&c.value.getTracks().forEach(m=>m.stop())}),(m,f)=>(_(),$("div",_e,[l.value?(_(),$("div",be,[w(ge,{color:"red"}),M("div",we,L(k(h)("labels.recording")),1)])):(_(),$("div",ye,L(k(h)("labels.hint")),1)),M("div",null,[k(u).is.mobile?(_(),H(Q,{key:0,color:"primary",disable:m.disable,icon:l.value?"mic_off":"mic",outline:"",round:"",size:"xl",onTouchstart:d,onTouchend:s,onContextmenu:f[0]||(f[0]=O(()=>{},["prevent"]))},null,8,["disable","icon"])):(_(),H(Q,{key:1,color:"primary",disable:m.disable,icon:l.value?"mic_off":"mic",outline:"",round:"",size:"xl",onMousedown:d,onMouseup:s,onContextmenu:f[1]||(f[1]=O(()=>{},["prevent"]))},null,8,["disable","icon"]))])]))}});class xe{url;_closeHandlers=new Map;_eventHandlers=new Map;_openHandlers=new Map;_ws;constructor(t,n){this.url=`wss://ws.coze.cn/v1/chat?authorization=Bearer ${t}&bot_id=${n}`,this._connect()}destroy(){this._ws&&(this._ws.onclose=null,this._ws.close(),this._ws=void 0),this._closeHandlers.clear(),this._eventHandlers.clear(),this._openHandlers.clear()}setCloseHandler(t,n){this._closeHandlers.set(t,n)}deleteCloseHandler(t){this._closeHandlers.delete(t)}setEventHandler(t,n){Array.isArray(t)?t.forEach(i=>{this._eventHandlers.set(i,n)}):this._eventHandlers.set(t,n)}deleteEventHandler(t){this._eventHandlers.delete(t)}isOpen(){return this._ws?.readyState===WebSocket.OPEN}sendEvent(t,n,i={}){this.sendRaw(JSON.stringify({...i,id:t,event_type:n}))}sendRaw(t){this.isOpen()?this._ws?.send(t):console.log("WebSocket not connected")}_connect(){this._ws=new WebSocket(this.url),this._ws.onclose=async t=>{D.create({type:"negative",message:"WebSocket closed, reconnecting...",icon:"close"});for(const[,n]of this._closeHandlers)await n(t);setTimeout(()=>{this._connect()},3e3)},this._ws.onmessage=async t=>{const n=JSON.parse(t.data);console.log(n);const i=this._eventHandlers.get(n.event_type);i?await i(n):D.create({type:"warning",message:`Unknown event_type: ${n.event_type}`,caption:t.data,icon:"help_outline"})},this._ws.onopen=()=>console.log("WebSocket opened!")}}const Se=e=>({data:{chat_config:{auto_save_history:!0,user_id:e,meta_data:{},custom_variables:{},extra_params:{},parameters:{}},input_audio:{format:"wav",codec:"pcm",sample_rate:24e3,channel:1,bit_depth:16},output_audio:{codec:"pcm",speech_rate:0,voice_id:"7426725529589596187"}}});var p=(e=>(e.chatUpdate="chat.update",e.inputAudioBufferAppend="input_audio_buffer.append",e.inputAudioBufferComplete="input_audio_buffer.complete",e.inputAudioBufferClear="input_audio_buffer.clear",e.conversationMessageCreate="conversation.message.create",e.conversationClear="conversation.clear",e.conversationChatSubmitToolOutputs="conversation.chat.submit_tool_outputs",e.conversationChatCancel="conversation.chat.cancel",e.chatCreated="chat.created",e.chatUpdated="chat.updated",e.conversationChatCreated="conversation.chat.created",e.conversationChatInProgress="conversation.chat.in_progress",e.conversationMessageDelta="conversation.message.delta",e.conversationAudioDelta="conversation.audio.delta",e.conversationMessageCompleted="conversation.message.completed",e.conversationAudioCompleted="conversation.audio.completed",e.conversationChatCompleted="conversation.chat.completed",e.conversationChatFailed="conversation.chat.failed",e.error="error",e.inputAudioBufferCompleted="input_audio_buffer.completed",e.inputAudioBufferCleared="input_audio_buffer.cleared",e.conversationCleared="conversation.cleared",e.conversationChatCanceled="conversation.chat.canceled",e.conversationAudioTranscriptUpdate="conversation.audio_transcript.update",e.conversationAudioTranscriptCompleted="conversation.audio_transcript.completed",e.conversationChatRequiresAction="conversation.chat.requires_action",e.inputAudioBufferSpeechStarted="input_audio_buffer.speech_started",e.inputAudioBufferSpeechStopped="input_audio_buffer.speech_stopped",e))(p||{});async function He(e,t=24e3,n=1,i=16){const u=await e.arrayBuffer(),h=i/8,g=u.byteLength,l=new ArrayBuffer(44),r=new DataView(l);N(r,0,"RIFF"),r.setUint32(4,36+g,!0),N(r,8,"WAVE"),N(r,12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,n,!0),r.setUint32(24,t,!0),r.setUint32(28,t*n*h,!0),r.setUint16(32,n*h,!0),r.setUint16(34,i,!0),N(r,36,"data"),r.setUint32(40,g,!0);const c=new Uint8Array(l.byteLength+u.byteLength);return c.set(new Uint8Array(l),0),c.set(new Uint8Array(u),l.byteLength),new Blob([c],{type:"audio/wav"})}function N(e,t,n){for(let i=0;i<n.length;i++)e.setUint8(t+i,n.charCodeAt(i))}const ke={class:"col-grow column items-center justify-center q-gutter-y-md"},Me={class:"column full-width"},Be=["src"],Ue={class:"column"},Ae=Z({__name:"HomePage",setup(e){const{notify:t,screen:n}=T(),i=y(()=>n.lt.md),u=z("pages.HomePage"),h=x(""),g=x(""),l=x(""),r=x(!1),c=x([]),d=x(""),s=x(),m=()=>{if(!d.value){console.warn("userId is empty");return}const b=Se(d.value);s.value&&f(),s.value=new xe(h.value,g.value),s.value.setCloseHandler("chat.disable_recording",()=>{r.value=!1}),s.value.setEventHandler(p.chatCreated,()=>{s.value?.sendEvent("chat.update_config",p.chatUpdate,l.value?.length?{...b,conversation_id:l}:b)}),s.value.setEventHandler(p.chatUpdated,a=>{r.value=!0,l.value=a.data.chat_config.conversation_id}),s.value.setEventHandler(p.conversationChatCreated,a=>{console.log(`Received ${a.event_type}: ${a.data.conversation_id}`),c.value.push({isFinished:!1,isSent:!1,audioChunks:[]})}),s.value.setEventHandler(p.conversationChatInProgress,async a=>{console.log(`Received ${a.event_type}: ${a.data.conversation_id}`),await S(!1,()=>{a.data.last_error&&t({type:"negative",message:a.data.last_error.Msg,caption:a.data.last_error.Code.toString()})},a.event_type)}),s.value.setEventHandler([p.conversationMessageDelta,p.conversationMessageCompleted],async a=>await S(!1,o=>{a.data.type==="answer"?o.text=a.data.content:console.log(a)},a.event_type)),s.value.setEventHandler(p.conversationAudioDelta,async a=>await S(!1,o=>{a.data.type==="answer"?o.audioChunks?.push(ue(a.data.content)):console.log(a)},a.event_type)),s.value.setEventHandler(p.conversationAudioCompleted,async a=>await S(!1,async o=>{a.data.type==="answer"?o.audioSrc=URL.createObjectURL(await He(new Blob(o.audioChunks))):console.log(a)},a.event_type)),s.value.setEventHandler(p.conversationChatCompleted,async a=>await S(!1,o=>{a.data.last_error&&t({type:"negative",message:a.data.last_error.Msg,caption:a.data.last_error.Code.toString()}),o.isFinished=!0,console.log(c.value)},a.event_type)),s.value.setEventHandler(p.inputAudioBufferCompleted,()=>{}),s.value.setEventHandler(p.conversationAudioTranscriptUpdate,async a=>await S(!0,o=>{o.text=a.data.content},a.event_type)),s.value.setEventHandler(p.conversationAudioTranscriptCompleted,async a=>await S(!0,o=>{o.text=a.data.content,o.isFinished=!0},a.event_type))},f=()=>{s.value&&(s.value.destroy(),s.value=void 0),r.value=!1},S=async(b,a,o="")=>{const A=c.value.findLast(P=>!P.isFinished&&P.isSent===b);A?await a(A):t({type:"negative",message:u("labels.noUnfinishedMessage"),caption:o})},W=async b=>{const a=await de(b);c.value.push({isFinished:!1,isSent:!0,audioChunks:[b],audioSrc:URL.createObjectURL(b)}),s.value?.sendEvent("chat.input_audio_append",p.inputAudioBufferAppend,{data:{delta:a.substring(a.indexOf(",")+1)}}),s.value?.sendEvent("chat.input_audio_complete",p.inputAudioBufferComplete)};return E(()=>{f(),c.value.forEach(b=>{b.audioSrc&&URL.revokeObjectURL(b.audioSrc)})}),(b,a)=>(_(),H(pe,{class:"row justify-center q-pa-md-xl q-pa-md"},{default:C(()=>[M("div",ke,[a[3]||(a[3]=M("div",{class:"text-h4 text-weight-regular"},"Voice Chat Test",-1)),M("div",{class:q(["full-width",{"column q-gutter-y-sm":i.value,"row q-gutter-x-sm":!i.value}])},[w(R,{class:q({"col-grow":!i.value}),autofocus:!0,clearable:"",dense:i.value,label:k(u)("labels.accessToken"),outlined:"",modelValue:h.value,"onUpdate:modelValue":a[0]||(a[0]=o=>h.value=o)},null,8,["class","dense","label","modelValue"]),w(R,{class:q({"col-grow":!i.value}),autofocus:!0,clearable:"",dense:i.value,label:k(u)("labels.botId"),outlined:"",modelValue:g.value,"onUpdate:modelValue":a[1]||(a[1]=o=>g.value=o)},null,8,["class","dense","label","modelValue"]),w(R,{class:q({"col-grow":!i.value}),autofocus:!0,clearable:"",dense:i.value,label:k(u)("labels.userId"),outlined:"",modelValue:d.value,"onUpdate:modelValue":a[2]||(a[2]=o=>d.value=o)},null,8,["class","dense","label","modelValue"])],2),s.value?(_(),H(Q,{key:0,color:"negative",dense:i.value,icon:"link_off",label:k(u)("labels.disconnect"),onClick:f},null,8,["dense","label"])):(_(),H(Q,{key:1,color:"primary",dense:i.value,disable:!h.value||!g.value,icon:"link",label:k(u)("labels.connect"),onClick:m},null,8,["dense","disable","label"])),w(se,{class:"col-grow full-width",bordered:"",flat:""},{default:C(()=>[M("div",Me,[(_(!0),$(oe,null,re(c.value,(o,A)=>(_(),H(fe,{key:A,sent:o.isSent},{default:C(()=>[w(le,{dense:"",separator:""},{default:C(()=>[o.isFinished?V("",!0):(_(),H(F,{key:0},{default:C(()=>[w(J,{avatar:""},{default:C(()=>[w(me)]),_:1}),w(K,null,{default:C(()=>[j(L(k(u)("labels.processing")),1)]),_:1})]),_:1})),o.audioSrc?(_(),H(F,{key:1},{default:C(()=>[w(J,null,{default:C(()=>[M("audio",{controls:"",src:o.audioSrc},null,8,Be)]),_:2},1024)]),_:2},1024)):V("",!0),o.text?(_(),H(F,{key:2},{default:C(()=>[w(K,null,{default:C(()=>[j(L(o.text),1)]),_:2},1024)]),_:2},1024)):V("",!0)]),_:2},1024)]),_:2},1032,["sent"]))),128))])]),_:1}),M("div",Ue,[w(Ce,{disable:!r.value||!!c.value.find(o=>o.isSent&&!o.isFinished),onStop:W},null,8,["disable"])])])]),_:1}))}}),qe=(e,t)=>{const n=e.__vccOpts||e;for(const[i,u]of t)n[i]=u;return n},Ve=qe(Ae,[["__scopeId","data-v-9c0c7b97"]]);export{Ve as default};
